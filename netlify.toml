[build]
  command = "npm run build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[build.environment]
  NODE_VERSION = "20"
  NPM_FLAGS = "--legacy-peer-deps"
  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD = "true"
  PUPPETEER_EXECUTABLE_PATH = "/usr/bin/chromium-browser"

# Function configuration for API routes
[functions]
  node_bundler = "esbuild"
  included_files = ["lib/**"]
  directory = "netlify/functions"

# Daily scheduler - analyzes fixtures and creates update schedule
# Runs once daily at 2 AM UTC to schedule updates for upcoming matches
# Calculates when each match will finish (start + 120 min) and stores in scheduled_updates table
[functions."schedule-updates"]
  schedule = "0 2 * * *"

# Auto-update function - runs when matches finish
# Uses pre-calculated schedule from schedule-updates function:
# - Runs every 5 minutes (just to check if it's time)
# - Checks scheduled_updates table for updates that should run now
# - If scheduled update found → updates results & standings
# - If no scheduled updates → exits immediately (<1 second, minimal cost)
# - This way it ONLY runs when matches actually finish (based on schedule)
[functions."auto-update"]
  schedule = "*/5 * * * *"

# Scheduled function for updating standings (backup/fallback)
# Runs every 6 hours as a safety net to keep standings fresh
# Note: Standings are also updated automatically by auto-update function
# when matches finish (120 minutes after match start)
[functions."update-standings"]
  schedule = "0 */6 * * *"

# Comprehensive security headers
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    Permissions-Policy = "camera=(), microphone=(), geolocation=(), interest-cohort=(), attribution-reporting=()"

# API-specific security headers
[[headers]]
  for = "/api/*"
  [headers.values]
    Content-Security-Policy = "default-src 'none'; frame-ancestors 'none'"
    X-Permitted-Cross-Domain-Policies = "none"
    Cross-Origin-Embedder-Policy = "require-corp"
    Cross-Origin-Opener-Policy = "same-origin"
    Cross-Origin-Resource-Policy = "same-origin"

# Sensitive API endpoints - additional restrictions
[[headers]]
  for = "/api/refresh"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

# Compression headers for better performance
[[headers]]
  for = "/*.{js,css,json,html,txt}"
  [headers.values]
    Content-Encoding = "gzip"

[[headers]]
  for = "/*.{js,css,json,html,txt}"
  [headers.values]
    Content-Encoding = "br"

# API routes set their own Cache-Control headers for optimal performance
# Background refresh pattern ensures fast responses while keeping data fresh

[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/icon-*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Environment variables (set these in Netlify dashboard)
# Required for Puppeteer on Netlify:
# - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true (set above - use system Chromium)
# - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser (set above)

